<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ElixpoSearch Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px auto;
            max-width: 600px;
            color: #333;
        }
        #thinking {
            padding: 1em;
            background: #f9f9f9;
            border-left: 4px solid #00c3ff;
            margin-bottom: 1em;
            white-space: pre-wrap;
            font-family: monospace;
            color: #555;
        }
        #response {
            padding: 1em;
            border: 1px solid #ccc;
            background: #fff;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h1>ElixpoSearch</h1>

<input type="text" id="queryInput" placeholder="Type your question here..." style="width: 80%; padding: 10px;" value="what's 1+1?">
<button onclick="startSearch()" style="padding: 10px;">Search</button>

<h3>Thinking...</h3>
<div id="thinking">No activity yet.</div>

<h3>Final Response:</h3>
<div id="response">Awaiting response...</div>

<script>
    function startSearch() {
    const query = document.getElementById('queryInput').value;
    const thinkingArea = document.getElementById('thinking');
    const responseArea = document.getElementById('response');

    thinkingArea.textContent = "Thinking started...\n";
    responseArea.textContent = "Awaiting response...";

    // Close any previous EventSource
    if (window.currentEventSource) {
        window.currentEventSource.close();
    }

    // Clear areas for fresh search
    thinkingArea.textContent = "";
    responseArea.textContent = "";

    const sseUrl = 'http://127.0.0.1:5000/search/sse?query=' + encodeURIComponent(query);
    const eventSource = new EventSource(sseUrl);
    window.currentEventSource = eventSource;

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.message) {
                thinkingArea.textContent += data.message + "\n";
            }
        } catch (e) {
            thinkingArea.textContent += "\n[Error parsing SSE data]\n";
        }
    };

    eventSource.addEventListener('final', function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.content) {
                responseArea.innerHTML = marked.parse(data.content);
            }
        } catch (e) {
            responseArea.textContent = "[Error parsing final response]";
        }
    });

    eventSource.addEventListener('close', function(event) {
        eventSource.close();
    });

    eventSource.onerror = function(err) {
        thinkingArea.textContent += "\n[Connection error]\n";
        responseArea.textContent = "SSE connection failed.";
        eventSource.close();
    };
}


    function startSearchGET() {
        const query = document.getElementById('queryInput').value;
        document.getElementById('thinking').textContent = "Thinking started (GET)...\n";
        document.getElementById('response').textContent = "Awaiting response...";

        fetch('http://127.0.0.1:5000/search?query=' + encodeURIComponent(query))
        .then(response => response.json())
        .then(data => {
            document.getElementById('thinking').textContent += "Done!\n";
            if (data.output) {
                document.getElementById('response').innerHTML = marked.parse(data.output);
            } else if (data.error) {
                document.getElementById('response').textContent = data.error;
            } else {
                document.getElementById('response').textContent = "No response received.";
            }
        })
        .catch(err => {
            document.getElementById('thinking').textContent += "\n[Error]\n";
            document.getElementById('response').textContent = "Request failed: " + err;
        });
    }

    function startOpenAIStyle() {
        const query = document.getElementById('queryInput').value;
        document.getElementById('thinking').textContent = "Thinking started (OpenAI style)...\n";
        document.getElementById('response').textContent = "Awaiting response...";

        fetch('http://127.0.0.1:5000/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [
                    { role: "user", content: query }
                ]
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('thinking').textContent += "Done!\n";
            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                document.getElementById('response').innerHTML = marked.parse(data.choices[0].message.content);
            } else if (data.error) {
                document.getElementById('response').textContent = data.error;
            } else {
                document.getElementById('response').textContent = "No response received.";
            }
        })
        .catch(err => {
            document.getElementById('thinking').textContent += "\n[Error]\n";
            document.getElementById('response').textContent = "Request failed: " + err;
        });
    }
</script>

<!-- Include marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
</html>