<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ElixpoSearch Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px auto;
            max-width: 600px;
            color: #333;
        }
        #thinking {
            padding: 1em;
            background: #f9f9f9;
            border-left: 4px solid #00c3ff;
            margin-bottom: 1em;
            white-space: pre-wrap;
            font-family: monospace;
            color: #555;
        }
        #response {
            padding: 1em;
            border: 1px solid #ccc;
            background: #fff;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h1>ElixpoSearch</h1>

<input type="text" id="queryInput" placeholder="Type your question here..." style="width: 80%; padding: 10px;" value="what's 1+1?">
<button onclick="startSearch()" style="padding: 10px;">Search</button>

<h3>Thinking...</h3>
<div id="thinking">No activity yet.</div>

<h3>Final Response:</h3>
<div id="response">Awaiting response...</div>

<script>
    let eventSource;

    function startSearch() {
        const query = document.getElementById('queryInput').value;
        document.getElementById('thinking').textContent = "Thinking started...\n";
        document.getElementById('response').textContent = "Awaiting response...";

        if (eventSource) {
            eventSource.close();
        }

        // Only use SSE GET request, as the backend expects query param for SSE
        const sseUrl = 'http://127.0.0.1:5000/search/sse?query=' + encodeURIComponent(query);
        eventSource = new EventSource(sseUrl);

        let thinkingArea = document.getElementById('thinking');
        let fullResponse = '';

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                thinkingArea.textContent += data.message + "\n";

                if (thinkingArea.textContent.length > 5000) {
                    thinkingArea.textContent = thinkingArea.textContent.slice(-5000); // Keep it readable
                }

                if (data.message.startsWith('--- ElixpoSearch Final Answer ---')) {
                    fullResponse = '';
                }

                // Collect final response
                if (data.message.startsWith('--- ElixpoSearch Final Answer ---') ||
                    fullResponse !== '') {
                    fullResponse += data.message + '\n';
                }

                // If the backend signals done, or the stream is closed, render
                if (data.done) {
                    eventSource.close();
                    document.getElementById('response').innerHTML = marked.parse(fullResponse);
                }
            } catch (e) {
                // Handle possible JSON parse errors or other issues
                thinkingArea.textContent += "\n[Error parsing SSE data]\n";
            }
        };

        eventSource.addEventListener('close', function() {
            eventSource.close();
            document.getElementById('response').innerHTML = marked.parse(fullResponse);
        });

        eventSource.onerror = (err) => {
            console.error('EventSource failed:', err);
            eventSource.close();
            thinkingArea.textContent += "\nConnection closed.";
        };
    }
</script>

<!-- Include marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
</html>