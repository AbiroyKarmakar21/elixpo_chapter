name: AI Issue Assistant

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  ai-assist:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || contains(github.event.issue.labels.*.name, 'needs-help')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Analyze Issue
        id: analyze
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          PROJECT_CONTEXT=$(cat .github/PROJECT_CONTEXT.md)
          
          PROMPT="You are a helpful assistant for Memory-Arc, a Python memory management system for AI applications.

          PROJECT CONTEXT:
          $PROJECT_CONTEXT

          A user has opened an issue. Analyze it and provide:
          1. **Issue Type**: Bug, Feature Request, Question, or Documentation
          2. **Severity**: Low, Medium, High, Critical
          3. **Suggested Labels**: Recommend 2-3 labels
          4. **Initial Response**: Helpful response to the user
          5. **Action Items**: What maintainers should do

          Issue Title: $ISSUE_TITLE

          Issue Body:
          $ISSUE_BODY

          Provide a structured response in markdown."

          RESPONSE=$(curl -s -X POST "https://text.pollinations.ai/openai" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.POLLI_TOKEN }}" \
            -d "{
              \"model\": \"gemini\",
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}],
              \"temperature\": 0.4,
              \"max_tokens\": 1000
            }" | jq -r '.choices[0].message.content')

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post AI Analysis
        uses: actions/github-script@v6
        with:
          script: |
            const response = `## ðŸ¤– AI Issue Analysis

            ${{ steps.analyze.outputs.response }}

            ---
            *This analysis was generated by AI. A maintainer will review shortly.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });
